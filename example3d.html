<!DOCTYPE html>
<!-- saved from url=(0043)https://klacansky.com/open-scivis-datasets/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <title>ViSUS WebViewer 3D</title>

</head>


<body>

<div id="viewer">
        
        <div>
          <table cellspacing="0" cellpadding="0" style='height:100%;width:100%; position: absolute; top: 0; bottom: 0; left: 0; right: 0;'>
  
  <tr style='height:100%'>
    <td align="center">
      
      <canvas width="1000" height="600" ></canvas>
    </td>
  </tr>
  
  <tr>
    <td>
      <table width='100%' style='background-color:#B0B0B0;'>
        <tr>
          <td> <label>Server</label>
          <td> <input id='server' size=32 onchange='setServer(this.value);' class='toolbar_value'>
          <td> <label>Volume render</label>
          <td> <input id='vr_cb' type='checkbox' size=32 onchange='onVRChange(this.value);' class='toolbar_value' checked>
            
          <td> <label>Dataset</label>
          <td> <select id='dataset' onchange='setDataset(this.value);' class='toolbar_value'>
            
          <td><label>Field</label>
          <td><select id='field' onchange='onFieldChange(this.value);' class='toolbar_value' /> 
          <td><label id="comp_range"> [...] </label>

          <td><label>Res</label>
          <td><input  id='resolution' type='range' step='1' min='0' step='1' max='33' style='width:100%' oninput='onResolutionChange(this.value);'>
          <td><input id='edit_resolution' size=2 onchange='onResolutionChange(this.value);' class='toolbar_value'>
          <td><label id="size_est"> ... KB </label>
          <td><input type='button' value='Download' onclick='download()'/>
        </tr>
      </table>
    </td>   
  </tr>    
  
  <tr>
    <td>
      <table width='100%' style='background-color:#B0B0B0'>
        
        <tr>
          <td><label>Axis</label>
          <td>
            <select id='axis' onchange='onAxisChange(this.value);' class='toolbar_value' disabled>
              <option value='2'>Z</option>
              <option value='1'>Y</option>
              <option value='0'>X</option>
            </select>
          
          <td><label>Slice</label>
          <td width='50%'>
            <table width='100%'>
              <tr width='100%'>
                <td width='100%'>
                  <input id='slice' type='range' min='0' step='1' max='100' style='width:100%' oninput='onSliceChange(this.value);' disabled/>
                <td>
                  <input id='edit_slice' size=2 onchange='onSliceChange(this.value);' class='toolbar_value' disabled>
              </tr>
            </table>
            
          <td><label>Time</label>       
          <td width='50%'>
            <table width='100%'>
              <tr width='100%'>            
                <td width='100%'><input  id='time' type='range' step='1' style='width:100%' oninput='onTimeChange(this.value);'>
                <td><input id='edit_time' size=2 onchange='onTimeChange(this.value);' class='toolbar_value'>
              </tr>
            </table>                  
           
          <td><label>Palette</label>     
          <td>
            <select id='palette' onchange='onPaletteChange();' class='toolbar_value'>
              <option value=''></option>
<!--               <option value='grayopaque'>grayopaque</option>
              <option value='graytransparent'>graytransparent</option> -->
           <!--    <option value='hsl'>hsl</option>
              <option value='banded'>banded</option>
              <option value='bry'>bry</option>
              <option value='bgry'>bgry</option> -->
              <option value='gamma'>gamma</option>
              <!-- <option value='hot1'>hot1</option>
              <option value='hot2'>hot2</option>
              <option value='ice'>ice</option>
              <option value='lighthues'>lighthues</option> -->
              <option value='rich'>rich</option>
              <option value='smoothrich'>smoothrich</option>
              <!-- <option value='lut16'>lut16</option>
              <option value='BlueGreenDivergent'>BlueGreenDivergent</option>-->
              <!-- <option value='AsymmetricBlueGreenDivergent'>AsymmetricBlueGreenDivergent</option> -->
            <!--  <option value='GreenGold'>GreenGold</option>
              <option value='LinearGreen'>LinearGreen</option>
              <option value='LinearTurquois'>LinearTurquois</option>
              <option value='MutedBlueGreen'>MutedBlueGreen</option>
              <option value='ExtendedCoolWarm'>ExtendedCoolWarm</option>
              <option value='AsymmetricBlueOrangeDivergent'>AsymmetricBlueOrangeDivergent</option>
              <option value='LinearYellow'>LinearYellow</option>
              <option value='LinearGray5'>LinearGray5</option>
              <option value='LinearGray4'>LinearGray4</option>      -->
            </select>
              
          <td><label>Min</label>
          <td><input id='palette_min' size=2 onchange='onPaletteChange();' class='toolbar_value'>
            
          <td><label>Max</label> 
          <td><input id='palette_max' size=2 onchange='onPaletteChange();' class='toolbar_value'>
            
          <!-- <td><label>Interpolation</label>    
          <td>
            <select id='palette_interp' onchange='onPaletteChange();' class='toolbar_value'>
              <option value='Default'>Default</option>
              <option value='Flat'>Flat</option>
              <option value='Inverted'>Inverted</option>
            </select>  -->
        </tr>
      </table>
      
    </td>
  </tr>
  
<table>

            <!-- 
                <label>Resolution:<input id="resolution_select" type="range" step="1"></label>
                <button>Submit</button>

                <label>Isovalue:<input id="isovalue_select" type="range" step="0.01"></label> -->
                <!-- <a onclick="vr_present()">VR</a> -->
        </div>
</div>

<!-- <details ontoggle="load_dataset(this, &#39;aneurism&#39;, {level: 24, width: 256, height: 256, depth: 256}, &#39;uint8&#39;, {width: 256.0, height: 256.0, depth: 256.0})"/> -->

<script src="./src3d/colormaps.js"></script>
<script src="./src3d/dvr.js"></script>
<script src="./src3d/visus.js"></script>

<script>

var visus1;


function fetch_and_draw(query_str, reset_view=1)
{
  data_size=[256, 256, 256]
  dtype='uint8'

  fetch(query_str, {method:'get'})
    .then(response => {
      if (!response.ok)
        throw new Error('Response not ok: ' + response.statusText)
      
      nsamples=response.headers.get('visus-nsamples')
      var dims=nsamples.split(' ');
      data_size[0]=parseInt(dims[0]);
      data_size[1]=parseInt(dims[1]);
      data_size[2]=parseInt(dims[2]);
     
      if(isNaN(data_size[2]))
        data_size[2]=1

      visus1.setNSamples(data_size)
      console.log(data_size)

      dtype=response.headers.get('visus-dtype')

      console.log(dtype)

      return response.arrayBuffer()
    }).then(data => {
      
      upload_data(gl, data, {level: level, width: data_size[0], height: data_size[1], depth: data_size[2]}, dtype, 
                  {width: data_size[0], height: data_size[1], depth: data_size[2]})

      viewer.style.display = 'block'

      let pal_min= parseFloat(document.getElementById('palette_min').value)
      let pal_max= parseFloat(document.getElementById('palette_max').value)

      console.log("update color map "+pal_min+" "+pal_max)
      updateColorMap(pal_min, pal_max);

      var range=get_data_extent();
      console.log("R:"+range[0]+", "+range[1])
      document.getElementById('comp_range').innerHTML="["+parseFloat(range[0]).toFixed(3)+", "+parseFloat(range[1]).toFixed(3)+"]"
      
      if(reset_view==1)
        resetView()

      render();

    }).catch(e => {
    console.log(e);
  });

}


//refreshAll
function refreshAll(reset_view=1)
{
  query_str = visus1.refresh();

  fetch_and_draw(query_str, reset_view)
  
  // document.getElementById('slice').max=visus1.dataset.pow2dims[visus1.getAxis()]-1;  
  // document.getElementById('axis').value=visus1.getAxis();
  // document.getElementById('slice').value=visus1.getSlice();
  // document.getElementById('edit_slice').value=visus1.getSlice();
  document.getElementById('field').value=visus1.getField();
  document.getElementById('time').value=visus1.getTime();
  document.getElementById('edit_time').value=visus1.getTime();

  // document.getElementById('palette').value=visus1.getPalette();
  // document.getElementById('palette_min').value=visus1.getPaletteMin();
  // document.getElementById('palette_max').value=visus1.getPaletteMax();
  // document.getElementById('palette_interp').value=visus1.getPaletteInterp();

}

///////////////////////////////////////////////////////
function getServer() {
  return document.getElementById('server').value;
}

///////////////////////////////////////////////////////
function setServer(value)
{
  document.getElementById('server').value=value;
  
  visusAsyncGetListOfDatasets(value+'&action=list&format=json')
  .then(function (datasets) 
  { 
    dataset_widget=document.getElementById('dataset');
    dataset_widget.options.length = 0;
    for(var i = 0; i < datasets.length; i++) 
    {
      var value = datasets[i];
      var item = document.createElement("option");
      item.textContent = value;
      item.value=item.value = value;
      dataset_widget.appendChild(item);
    }     
    
    setDataset(datasets[0]);
  });
}


///////////////////////////////////////////////////////
function getDataset() {
  return document.getElementById('dataset').value;
}

///////////////////////////////////////////////////////
function setDataset(value) 
{
  document.getElementById('dataset').value=value;

  // reset palette
  document.getElementById('palette_min').value="";
  document.getElementById('palette_max').value="";

  document.getElementById('vr_cb').checked=true
  document.getElementById('axis').disabled=true
  document.getElementById('axis').value='2'
  document.getElementById('slice').disabled=true
  document.getElementById('edit_slice').disabled=true

  dataset_url=getServer()+'action=read_dataset&dataset='+value
  level=24

  query_str = visusAsyncLoadDataset(dataset_url).then(function (dataset) {

    //update fieldnames
    {
      field_widget=document.getElementById('field');
      field_widget.options.length = 0;
      for(var i = 0; i < dataset.fields.length; i++) 
      {
        var fieldname = dataset.fields[i].name;
        var item = document.createElement("option");
        item.textContent = fieldname;
        item.value=item.value = fieldname;
        field_widget.appendChild(item);
      }  
    }   
    
    document.getElementById('resolution').max=dataset.maxh

    //update time range
    {
      time_widget=document.getElementById('time');
      time_widget.min=dataset.timesteps[0];
      time_widget.max=dataset.timesteps[1];
      time_widget.step=1;
    }   

    //lauch visus_widget
    visus1=VisusVR({
      id : 'visus1',
      dataset : dataset,
      compression : 'raw',
      showNavigator : false,
      debugMode : false
    }); 
    
    refresh();

    refreshAll();
    //fetch_and_draw(visus1.query_str)

  });  

  //refreshAll();

}


function onAxisChange(value){
  visus1.setAxis(value); refreshAll(0);
}

function onSliceChange(value){
  visus1.setSlice(value); 
  document.getElementById('edit_slice').value=value;
  document.getElementById('slice').value=value;
  refreshAll(0);
}

function onFieldChange(value){
  visus1.setField(value); refreshAll();
}

function onTimeChange(value){
  visus1.setTime(value); 
  document.getElementById('edit_time').value=value;
  document.getElementById('time').value=value;
  refreshAll(0);
}

function onResolutionChange(value){
  document.getElementById('resolution').value=value;
  document.getElementById('edit_resolution').value=value;

  size=visus1.getDataSize(value);
  document.getElementById('size_est').innerHTML="~"+parseFloat(size).toFixed(1)+"MB";

}

function onVRChange(){

  ischecked=document.getElementById('vr_cb').checked

  document.getElementById('axis').disabled=ischecked
  document.getElementById('slice').disabled=ischecked
  document.getElementById('edit_slice').disabled=ischecked

  visus1.setRenderType(ischecked);
  onSliceChange(50);
}

function onPaletteChange(){
  visus1.setPalette(document.getElementById('palette').value); 
  visus1.setPaletteMin(parseInt(document.getElementById('palette_min').value)); 
  visus1.setPaletteMax(parseInt(document.getElementById('palette_max').value)); 
  // visus1.setPaletteInterp(document.getElementById('palette_interp').value); 

  let pal_min= parseFloat(document.getElementById('palette_min').value)
  let pal_max= parseFloat(document.getElementById('palette_max').value)

  updateColorMap(pal_min, pal_max);
  render();
  //refreshAll(0);
}

function download(){
  sel_level = parseInt(document.getElementById('resolution').value)
  data_url = visus1.refresh(sel_level)

  out_size = []
  out_dtype = ""

  out_ext_file = ".raw"

  if(!document.getElementById('vr_cb').checked){
    data_url=data_url.split("compression=raw").join("compression=png");
    out_ext_file = ".png"
  }

  console.log("download req "+data_url)

  fetch(data_url, { method: 'GET'
        }).then(response => {
          nsamples=response.headers.get('visus-nsamples')
          var dims=nsamples.split(' ');
          out_size[0]=parseInt(dims[0]);
          out_size[1]=parseInt(dims[1]);
          out_size[2]=parseInt(dims[2]);
         
          if(isNaN(out_size[2]))
            out_size[2]=1

          console.log(out_size)

          out_dtype=response.headers.get('visus-dtype')

          console.log(out_dtype)

           response.blob().then( blob => {

            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = visus1.dataset.name+"_"+out_size[0]+"_"+out_size[1]+"_"+out_size[2]+"_"+out_dtype+"_lvl"+sel_level+out_ext_file;
            a.click();                    
          });
        });
}

setServer('http://molniya.sci.utah.edu:80/mod_visus?');
</script>

</body></html>